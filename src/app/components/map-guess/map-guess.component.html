<div class="map-guess-container" role="region" aria-labelledby="map-guess-heading">
  <!-- Map Instructions -->
  <div class="map-instructions">
    <h3 id="map-guess-heading">Where was this photo taken?</h3>
    <p class="instruction-text" id="map-instructions-text">{{ mapInstructions }}</p>
  </div>

  <!-- Map Container -->
  <div class="map-wrapper">
    <!-- Loading State -->
    <div *ngIf="isMapLoading" 
         class="map-loading"
         role="status"
         aria-live="polite"
         aria-label="Loading interactive map">
      <div class="loading-spinner" aria-hidden="true"></div>
      <p>Loading map...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="mapError" 
         class="map-error"
         role="alert"
         aria-live="assertive">
      <div class="error-icon" aria-hidden="true">âš ï¸</div>
      <p>{{ mapError }}</p>
      <button class="retry-button" 
              (click)="retryMapInitialization()"
              type="button"
              aria-label="Retry loading the interactive map">
        Retry
      </button>
    </div>

    <!-- Map Container -->
    <div 
      #mapContainer 
      class="map-container"
      [class.map-hidden]="isMapLoading || mapError"
      role="application"
      aria-label="Interactive world map for location guessing. Click to place your location guess."
      [attr.aria-describedby]="'map-instructions-text accessibility-instructions'"
      tabindex="0"
      (keydown)="onMapKeyDown($event)"
    ></div>
  </div>

  <!-- Map Controls -->
  <div class="map-controls" 
       *ngIf="isMapInitialized && !mapError"
       role="region"
       aria-labelledby="map-controls-heading">
    <h4 id="map-controls-heading" class="sr-only">Map Controls</h4>
    
    <!-- Pin Information -->
    <div class="pin-info" role="status" aria-live="polite">
      <div class="pin-status" [attr.aria-label]="getPinStatusAriaLabel()">
        <span class="pin-icon" 
              [class.pin-active]="hasValidPin"
              aria-hidden="true">ğŸ“</span>
        <span class="pin-coordinates">{{ pinDisplayText }}</span>
      </div>
    </div>

    <!-- Control Buttons -->
    <div class="control-buttons" role="group" aria-label="Map navigation controls">
      <button 
        class="control-button center-button"
        (click)="onCenterMap()"
        type="button"
        aria-label="Reset map to world view"
        [attr.aria-describedby]="'center-map-help'"
      >
        <span aria-hidden="true">ğŸŒ</span> Center Map
      </button>
      <div id="center-map-help" class="sr-only">Resets the map view to show the entire world</div>

      <button 
        class="control-button zoom-button"
        (click)="onZoomToPin()"
        [disabled]="!hasValidPin"
        type="button"
        aria-label="Zoom to your pin location"
        [attr.aria-describedby]="'zoom-pin-help'"
      >
        <span aria-hidden="true">ğŸ”</span> Zoom to Pin
      </button>
      <div id="zoom-pin-help" class="sr-only">Zooms the map to focus on your placed pin</div>

      <button 
        class="control-button remove-button"
        (click)="onRemovePin()"
        [disabled]="!hasValidPin"
        type="button"
        aria-label="Remove your location guess"
        [attr.aria-describedby]="'remove-pin-help'"
      >
        <span aria-hidden="true">ğŸ—‘ï¸</span> Remove Pin
      </button>
      <div id="remove-pin-help" class="sr-only">Removes your current location guess from the map</div>
    </div>
  </div>

  <!-- Accessibility Instructions -->
  <div class="accessibility-instructions" 
       id="accessibility-instructions"
       aria-live="polite"
       role="status">
    <p *ngIf="!hasValidPin">
      Click on the map to place your location guess. 
      Use the control buttons below to navigate the map. 
      Keyboard users: Focus the map and use arrow keys to navigate, Enter to place a pin.
    </p>
    <p *ngIf="hasValidPin">
      Location selected at {{ pinDisplayText }}. 
      Click elsewhere on the map or use keyboard navigation to adjust your guess.
    </p>
  </div>

  <!-- Additional keyboard instructions for screen readers -->
  <div class="sr-only">
    <h4>Keyboard Navigation Instructions</h4>
    <ul>
      <li>Focus the map and use arrow keys to move the crosshair cursor</li>
      <li>Press Enter or Space to place a pin at the cursor location</li>
      <li>Use + and - keys to zoom in and out</li>
      <li>Press Escape to remove the current pin</li>
      <li>Use Tab to navigate between map controls</li>
    </ul>
  </div>
</div>